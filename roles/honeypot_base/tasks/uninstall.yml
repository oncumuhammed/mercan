---
# =========================================================================
# Honeypot Base Role - Uninstall Tasks
# =========================================================================
# Removes honeypot and optionally cleans up data

- name: Stop and disable systemd service
  service:
    name: "{{ honeypot_service_name }}"
    state: stopped
    enabled: no
  ignore_errors: yes

- name: Stop Docker Compose containers
  command: docker compose down
  args:
    chdir: "{{ honeypot_compose_dir }}"
  ignore_errors: yes

- name: Remove Docker network
  docker_network:
    name: "{{ honeypot_config.network_name }}"
    state: absent
  ignore_errors: yes

- name: Remove systemd service file
  file:
    path: "/etc/systemd/system/{{ honeypot_service_name }}.service"
    state: absent

- name: Remove logrotate configuration
  file:
    path: "/etc/logrotate.d/{{ honeypot_name }}"
    state: absent

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Remove firewall rules
  include_tasks: remove_firewall_ports.yml
  loop: "{{ honeypot_config.ports }}"
  loop_control:
    loop_var: port_config

- name: Remove honeypot directories
  file:
    path: "{{ honeypot_compose_dir }}"
    state: absent
  when: remove_data | default(false)

- name: Display uninstall completion message
  debug:
    msg: "Honeypot {{ honeypot_name }} has been uninstalled"
